# Accounting Entries & Invoice Batches UI Specification

**Version:** 1.3
**Date:** 2026-02-04
**Status:** Draft for Review
**Author:** Claude Code

---

## 1. Executive Summary

This specification outlines an extension to the **jsg_gl_rules** app to include:
- Viewing accounting entries generated by GL rules
- Monitoring GL batch processing runs
- Managing invoice batches for on-account clients
- Exporting to accounting software (Xero, MYOB, CSV)

### Business Value
- **Visibility**: View accounting entries and batch processing history
- **Monitoring**: Track GL batch job status and any failures
- **Efficiency**: Streamlined invoice batch creation and export
- **Auditability**: Clear tracking of what has been processed and exported

---

## 2. User Personas

### Primary Users

**Finance Manager / Accountant**
- Reviews accounting entries for accuracy
- Monitors GL batch processing status
- Runs invoice batches for on-account clients
- Exports data to Xero/MYOB for reconciliation

**Operations Manager**
- Monitors revenue allocation across GL accounts
- Reviews commission expense allocations
- Needs high-level summary views

---

## 3. System Architecture Context

### Existing Backend Components

| Component | Status | Description |
|-----------|--------|-------------|
| `accounting_entries` table | Active | Stores GL allocations linked to money records (126 rows) |
| `sync_accounting_entries()` | Active | PostgreSQL function to sync entries from GL rules |
| `process_sales_batch()` | Active | PostgreSQL function for sales batch processing |
| `process_payment_batch()` | Active | PostgreSQL function for payment surcharge batch processing |
| `sales_batch_runs` table | Active | Tracks sales batch run history (88 rows) |
| `payment_batch_runs` table | Active | Tracks payment batch run history (92 rows) |
| `sales_batch_job_initiations` table | Active | Tracks job initiations with completion status and notes (71 rows) |
| `invoice_batches` table | Active | Stores invoice batch run metadata |
| `invoices` table | Active | Individual invoices per client |
| `invoice_line_items` table | Active | Payment line items on invoices |
| Invoice API endpoints | Active | Preview, execute, query, export endpoints |
| Export transformers | Active | CSV, Xero, MYOB format generators |

### Two Types of Batch Processing

**1. GL Batch Runs (Automatic - Overnight Jobs)**
- **Sales batches**: Process money records and create accounting entries based on GL rules
- **Payment batches**: Process payment surcharges and create accounting entries
- Run automatically overnight
- Can be triggered manually for catchup

**2. Invoice Batches (Manual - User Initiated)**
- Group on-account payments into client invoices
- User previews and executes via UI
- Export to accounting software

### Recognition System (Automatic)

Recognition of accounting entries is **handled automatically** by batch processing:
- `process_sales_batch()` syncs entries AND marks them as recognized
- `process_payment_batch()` does the same for payment surcharges
- Reversals are auto-recognized when GL rules change

### Export Tracking (Already Implemented)

| Endpoint | Marks Exported |
|----------|----------------|
| `POST /invoice-batch-export/{id}` | Yes (default `mark_exported=true`) |
| `GET /invoice-batch-export-download/{id}` | No (for re-downloads) |

### Data Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│ GL BATCH PROCESSING (Automatic)                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Bookings → Money Records                                               │
│                 ↓                                                        │
│        [Overnight Job Trigger]                                          │
│                 ↓                                                        │
│     process_sales_batch()  ──→  sales_batch_runs (history)             │
│                 ↓                                                        │
│     sync_accounting_entries()                                           │
│                 ↓                                                        │
│     GL Rules Evaluation (priority matching)                             │
│                 ↓                                                        │
│     accounting_entries (Revenue + Commission)                           │
│                 ↓                                                        │
│     Auto-Recognition (recognised_at = NOW())                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ INVOICE BATCHES (Manual)                                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  On-Account Payments (invoiced = false)                                 │
│                 ↓                                                        │
│     [User clicks "Create Batch"]                                        │
│                 ↓                                                        │
│     Preview → Execute                                                   │
│                 ↓                                                        │
│     invoice_batches → invoices → invoice_line_items                    │
│                 ↓                                                        │
│     Export to Xero/MYOB/CSV                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Navigation Structure

### Extended Tab Structure for jsg_gl_rules

```
GL Rules App Tabs:
├── Manage Accounts     (existing)
├── Manage Rules        (existing)
├── Surcharge Rules     (existing)
├── Accounting Entries  (NEW)
├── GL Batch Runs       (NEW)
└── Invoice Batches     (NEW)
```

The app will be renamed in the wrapper navigation:

```
Finance
├── Commissions
├── GL & Accounting    ← Renamed from "GL Rules"
├── Payment Terms
├── Payment Types
└── Revenue Management
```

---

## 5. Feature Specifications

### 5.1 Accounting Entries Tab

#### Purpose
View and monitor accounting entries generated by the GL rules evaluation system. This is a **read-only view** - recognition is automatic.

#### Page Layout

```
┌─────────────────────────────────────────────────────────────────┐
│  Accounting Entries                                    [Export] │
├─────────────────────────────────────────────────────────────────┤
│  Filters:                                                       │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ Date Range   │ │ GL Account   │ │ Status       │            │
│  │ [From] [To]  │ │ [Select...] ▼│ │ [All      ] ▼│            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│                                                                 │
│  ┌──────────────┐ ┌──────────────┐                              │
│  │ Entry Type   │ │ Search       │                              │
│  │ [All      ] ▼│ │ [Booking ref]│                              │
│  └──────────────┘ └──────────────┘                              │
├─────────────────────────────────────────────────────────────────┤
│  Summary Cards:                                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ Total Revenue│ │ Total Comm.  │ │ Entry Count  │            │
│  │   $45,230.00 │ │   $4,523.00  │ │      126     │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│  GL Account    │ Type      │ Amount    │ Status   │ Booking │ Created │
│  ─────────────────────────────────────────────────────────────────────  │
│  4000 Revenue  │ Revenue   │ $1,250.00 │ Pending  │ BK-001  │ Feb 3   │
│  4010 Ferry    │ Revenue   │   $850.00 │ Pending  │ BK-002  │ Feb 3   │
│  5100 Comm     │ Commission│  -$125.00 │ Recognized│ BK-001 │ Feb 2   │
│  4000 Revenue  │ Revenue   │  -$320.00 │ Reversal │ BK-003  │ Feb 2   │
│  4010 Ferry    │ Revenue   │   $320.00 │ Recognized│ BK-003 │ Feb 1   │
│  ...                                                                    │
├─────────────────────────────────────────────────────────────────┤
│  Showing 1-25 of 126 entries           [< Prev] [1] [2] [Next >]│
└─────────────────────────────────────────────────────────────────┘
```

#### Filters

| Filter | Type | Options |
|--------|------|---------|
| Date Range | Date Picker | From/To dates for `created_at` |
| GL Account | Dropdown | All accounts from `accounts` table |
| Status | Dropdown | All, Pending, Recognized, Reversal |
| Entry Type | Dropdown | All, Revenue, Commission |
| Search | Text | Booking reference |

#### Table Columns

| Column | Source | Sortable |
|--------|--------|----------|
| GL Account | `accounts.name` + `external_id` | Yes |
| Type | Revenue or Commission | Yes |
| Amount | `accounting_entries.amount` | Yes |
| Status | Pending/Recognized/Reversal | Yes |
| Booking | Via association lookup | Yes |
| Travel Date | Via reservation → service | Yes |
| Created | `accounting_entries.created_at` | Yes |

#### Status Display Logic

| Condition | Status Label | Style |
|-----------|--------------|-------|
| `recognised_at IS NULL` | Pending | Gray |
| `recognised_at IS NOT NULL AND amount > 0` | Recognized | Green |
| `recognised_at IS NOT NULL AND amount < 0` | Reversal | Orange |

#### Reversal Display

Both original and reversal entries are shown. Reversals have negative amounts and are visually distinct.

---

### 5.2 GL Batch Runs Tab

#### Purpose
Monitor the status of GL batch processing jobs (overnight jobs that sync accounting entries).

#### Page Layout

```
┌─────────────────────────────────────────────────────────────────┐
│  GL Batch Runs                                 [Run Catchup ▼]  │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────┐ ┌─────────────────────────────┐│
│  │ Sales Batches               │ │ Payment Batches             ││
│  └─────────────────────────────┘ └─────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│  Sales Batch Run History:                                       │
│  ─────────────────────────────────────────────────────────────  │
│  Run #  │ Date Range        │ Run At            │ Status       │
│  ────────────────────────────────────────────────────────────── │
│  #88    │ 1970-01-01 → 2026-01-07 │ Feb 3, 2:33 PM   │ Completed │
│  #87    │ 1970-01-01 → 2026-01-07 │ Feb 2, 2:35 PM   │ Completed │
│  #86    │ 1970-01-01 → 2026-01-07 │ Feb 1, 2:33 PM   │ Completed │
│  #85    │ 1970-01-01 → 2026-01-07 │ Jan 31, 2:30 PM  │ Completed │
│  ...                                                            │
├─────────────────────────────────────────────────────────────────┤
│  Showing 1-10 of 88 runs               [< Prev] [1] [2] [Next >]│
└─────────────────────────────────────────────────────────────────┘
```

#### Sub-tabs
- **Sales Batches**: Shows `sales_batch_runs` history
- **Payment Batches**: Shows `payment_batch_runs` history

#### Table Columns (Based on Actual Schema)

| Column | Source | Description |
|--------|--------|-------------|
| Run # | `id` | Batch run ID |
| Date Range | `start_date` → `end_date` | Period processed |
| Run At | `created_at` | When job ran |
| Status | Computed | Always "Completed" (jobs only create records on success) |

**Note:** The `sales_batch_runs` and `payment_batch_runs` tables only store basic metadata (id, start_date, end_date, created_at, updated_at). Detailed processing statistics (records processed, entries created, failed IDs) are captured in the `sales_batch_job_initiations.notes` field as text. The UI should display what's available.

#### Actions

**Run Catchup** (dropdown):
- **Sales Catchup**: Manually trigger `process_sales_batch()` for missed dates
- **Payment Catchup**: Manually trigger `process_payment_batch()`

#### Job Initiation Details (Optional Enhancement)

For more detailed batch history, link to `sales_batch_job_initiations`:
```
┌─────────────────────────────────────────────────────────────────┐
│  Batch Job Initiations                                          │
├─────────────────────────────────────────────────────────────────┤
│  ID   │ Batch Date  │ Completed │ Run At            │ Details    │
│  ─────────────────────────────────────────────────────────────  │
│  #84  │ 2026-02-04  │ ✓         │ Feb 3, 2:33 PM   │ [View]     │
│  #83  │ 2026-02-03  │ ✓         │ Feb 2, 2:35 PM   │ [View]     │
│  ...                                                            │
└─────────────────────────────────────────────────────────────────┘
```

The `notes` field contains detailed processing results that can be parsed for display.

---

### 5.3 Invoice Batches Tab

#### Purpose
Create, view, and export invoice batches for on-account clients.

#### Page Layout - Batch List

```
┌─────────────────────────────────────────────────────────────────┐
│  Invoice Batches                              [+ Create Batch]  │
├─────────────────────────────────────────────────────────────────┤
│  Filters:                                                       │
│  ┌──────────────┐ ┌──────────────┐                              │
│  │ Date Range   │ │ Export Status│                              │
│  │ [From] [To]  │ │ [All      ] ▼│                              │
│  └──────────────┘ └──────────────┘                              │
├─────────────────────────────────────────────────────────────────┤
│  Batch #  │ Issue Date │ Run By  │ Exported   │ Created          │
│  ──────────────────────────────────────────────────────────────  │
│  #12      │ 2026-02-04 │ manual  │ -          │ Feb 4, 10:30 AM  │
│  #11      │ 2026-02-03 │ sched   │ Feb 3 ✓    │ Feb 3, 9:00 AM   │
│  #10      │ 2026-02-02 │ manual  │ Feb 2 ✓    │ Feb 2, 11:15 AM  │
│  ...                                                              │
├─────────────────────────────────────────────────────────────────┤
│  Showing 1-10 of 12 batches            [< Prev] [1] [2] [Next >]│
└─────────────────────────────────────────────────────────────────┘
```

**Note:** Invoice and line item counts/totals are computed by joining to the `invoices` and `invoice_line_items` tables.

#### Actions
- **+ Create Batch**: Opens preview modal
- **Click Row**: Navigate to batch detail view

---

### 5.4 Create Invoice Batch Flow

#### Preview Modal

```
┌─────────────────────────────────────────────────────────────────┐
│  Create Invoice Batch                                      [X]  │
├─────────────────────────────────────────────────────────────────┤
│  Issue Date: [2026-02-04]  ☐ Include clients not due today      │
├─────────────────────────────────────────────────────────────────┤
│  Preview Summary:                                               │
│  • 8 invoices would be created                                  │
│  • 23 line items (payments)                                     │
│  • Total: $12,450.00                                           │
│                                                                 │
│  3 clients skipped (not invoice day)                           │
├─────────────────────────────────────────────────────────────────┤
│  Invoices to Create:                                            │
│  ─────────────────────────────────────────────────────────────  │
│  ▼ ABC Travel Agency           5 items        $4,230.00        │
│    └─ BK-2024-001  Ferry Auckland-Waiheke     $850.00          │
│    └─ BK-2024-002  Ferry Auckland-Waiheke     $1,280.00        │
│                                                                 │
│  ► XYZ Corporate               3 items        $2,100.00        │
│  ► Coastal Tours Ltd           8 items        $3,420.00        │
├─────────────────────────────────────────────────────────────────┤
│  Skipped (not invoice day):                                     │
│  • Adventure Co (weekly - invoices on Mondays)                  │
├─────────────────────────────────────────────────────────────────┤
│                                     [Cancel]  [Create Batch]    │
└─────────────────────────────────────────────────────────────────┘
```

---

### 5.5 Invoice Batch Detail View

```
┌─────────────────────────────────────────────────────────────────┐
│  ← Back                          Invoice Batch #12              │
├─────────────────────────────────────────────────────────────────┤
│  Issue Date: 2026-02-04    Run By: manual    Exported: -        │
├─────────────────────────────────────────────────────────────────┤
│  Summary:                                                       │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ Invoices: 8  │ │ Items: 23    │ │ $12,450.00   │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│  Export:                                                        │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐                  │
│  │    CSV     │ │    Xero    │ │    MYOB    │                  │
│  │ [Download] │ │ [Download] │ │ [Download] │                  │
│  └────────────┘ └────────────┘ └────────────┘                  │
│                                                                 │
│  Note: First download marks batch as exported.                  │
│  [Re-download CSV] [Re-download Xero] [Re-download MYOB]        │
├─────────────────────────────────────────────────────────────────┤
│  Invoices in Batch:                                             │
│  Client              │ External ID │ Items │ Total     │ Due Date │
│  ABC Travel Agency   │ ABC-001     │ 5     │ $4,230.00 │ Feb 18   │
│  XYZ Corporate       │ XYZ-002     │ 3     │ $2,100.00 │ Mar 4    │
│  ...                                                            │
└─────────────────────────────────────────────────────────────────┘
```

---

### 5.6 Client Invoice History (Deep Link)

**From jsg_clients**: "View Invoices" button deep-links to `/gl-rules?tab=invoices&client={id}`

Shows filtered view of that client's invoices with summary and history.

---

## 6. API Status

### Existing Endpoints (Ready to Use)

| Endpoint | Method | Purpose | Status |
|----------|--------|---------|--------|
| `/invoice-ready-payments` | GET | List payments ready to invoice | Active |
| `/invoice-batch-preview` | GET | Preview batch before creation | Active |
| `/invoice-batch-execute` | POST | Create batch | Active |
| `/invoice-batch/{id}` | GET | Get batch details with invoices | Active |
| `/client-invoice-history/{id}` | GET | Client's invoice history | Active |
| `/invoice-batch-export/{id}` | POST | Export batch (marks as exported) | Active |
| `/invoice-batch-export-download/{id}` | GET | Re-download export file | Active |
| `/invoice-export-formats` | GET | List available formats | Active |

### New Endpoints (Implemented & Deployed)

| Endpoint | Method | Purpose | Status |
|----------|--------|---------|--------|
| `/invoice-batches` | GET | List invoice batches with pagination | ✅ Deployed |
| `/gl-batch-runs-sales` | GET | List sales batch run history | ✅ Deployed |
| `/gl-batch-runs-payments` | GET | List payment batch run history | ✅ Deployed |
| `/gl-batch-runs-sales-catchup` | POST | Manually trigger sales batch | ✅ Deployed |
| `/gl-batch-runs-payments-catchup` | POST | Manually trigger payment batch | ✅ Deployed |
| `/gl-batch-runs-retry` | POST | Retry failed money records | ✅ Deployed |

---

### 6.1 GET /invoice-batches

**Purpose:** List all invoice batches with pagination and filtering.

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `page` | int | 1 | Page number |
| `page_size` | int | 20 | Items per page (max 100) |
| `status` | string | null | Filter: 'exported' or 'pending' |

**Response:**
```json
{
  "data": [
    {
      "id": 12,
      "issue_date": "2026-02-04",
      "run_by": "manual",
      "created_at": "2026-02-04T10:30:00+00:00",
      "updated_at": "2026-02-04T10:30:00+00:00",
      "exported_by": null,
      "exported_at": null
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total_items": 12,
    "total_pages": 1
  }
}
```

**Note:** Invoice counts and totals must be computed by joining to the `invoices` and `invoice_line_items` tables, either in the UI or via a separate query.

---

### 6.2 GET /gl-batch-runs-sales

**Purpose:** List sales batch run history.

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `page` | int | 1 | Page number |
| `page_size` | int | 20 | Items per page (max 100) |
| `start_date` | date | null | Filter by start_date >= |
| `end_date` | date | null | Filter by end_date <= |

**Response:**
```json
{
  "data": [
    {
      "id": 88,
      "start_date": "1970-01-01",
      "end_date": "2026-01-07",
      "created_at": "2026-02-03T14:33:44.129933",
      "updated_at": "2026-02-03T14:33:44.129933",
      "status": "completed"
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total_items": 88,
    "total_pages": 5
  }
}
```

**Note:** Detailed processing stats (records processed, entries created, etc.) are not stored in `sales_batch_runs`. They are in `sales_batch_job_initiations.notes` as text.

---

### 6.3 GET /gl-batch-runs-payments

**Purpose:** List payment batch run history.

**Response:** Same structure as `/gl-batch-runs-sales`.

---

### 6.4 POST /gl-batch-runs-sales-catchup

**Purpose:** Manually trigger sales batch processing for catchup.

**Request Body:**
```json
{
  "start_date": "2026-02-01",
  "end_date": "2026-02-03"
}
```

**Validation:**
- `start_date` required
- `end_date` required, must be >= `start_date`
- Date range cannot exceed 31 days
- `end_date` cannot be in the future

**Response:**
```json
{
  "success": true,
  "batch_run_id": 89,
  "message": "Sales batch catchup initiated",
  "summary": {
    "start_date": "2026-02-01",
    "end_date": "2026-02-03",
    "money_records_processed": 15,
    "entries_created": 45,
    "entries_synced": 45,
    "entries_reversed": 0,
    "entries_recognized": 45,
    "failed_money_ids": []
  }
}
```

---

### 6.5 POST /gl-batch-runs-payments-catchup

**Purpose:** Manually trigger payment batch processing.

**Request/Response:** Same structure as sales catchup.

---

### 6.6 POST /gl-batch-runs-retry

**Purpose:** Retry syncing specific failed money records.

**Request Body:**
```json
{
  "money_ids": [123, 456, 789],
  "batch_type": "sales"
}
```

**Validation:**
- `money_ids` required, non-empty array, max 100 items
- `batch_type` required, must be "sales" or "payments"

**Response:**
```json
{
  "success": true,
  "message": "Retry completed",
  "results": {
    "attempted": 3,
    "succeeded": 2,
    "failed": 1,
    "failed_money_ids": [789],
    "errors": {
      "789": "No active GL rule set for travel date"
    }
  }
}
```

---

### GraphQL for Accounting Entries

Accounting entries will be queried via Hasura GraphQL (no new API needed):

```graphql
query GetAccountingEntries($limit: Int, $offset: Int, $where: accounting_entries_bool_exp) {
  jsg_reference_schema_accounting_entries(
    limit: $limit
    offset: $offset
    where: $where
    order_by: { created_at: desc }
  ) {
    id
    amount
    recognised_at
    recognised_at_local
    association_type
    association_id
    deleted
    created_at
    updated_at
    account_id
  }
  jsg_reference_schema_accounting_entries_aggregate(where: $where) {
    aggregate {
      count
      sum { amount }
    }
  }
}
```

**Note:** To display booking reference, need to join via `association_id` → `money` → `reservation_id` → `booking`. This may require a view or resolver.

---

## 7. Technical Implementation

### Tab Routing

```typescript
// URL patterns
/gl-rules                           → Accounts tab (default)
/gl-rules?tab=accounts              → Accounts tab
/gl-rules?tab=rules                 → Rules tab
/gl-rules?tab=surcharges            → Surcharge Rules tab
/gl-rules?tab=entries               → Accounting Entries tab (NEW)
/gl-rules?tab=gl-batches            → GL Batch Runs tab (NEW)
/gl-rules?tab=invoices              → Invoice Batches tab (NEW)
/gl-rules?tab=invoices&client=123   → Invoices filtered by client
/gl-rules/rule-set/:id              → Rule set editor (existing)
/gl-rules/batch/:id                 → Invoice batch detail (NEW)
```

### New Components

```
src/
├── pages/
│   ├── GLRulesApp.tsx              # Add new tabs
│   ├── GLRuleSetEditor.tsx         # Existing
│   └── InvoiceBatchDetail.tsx      # NEW
├── components/
│   └── gl-rules/
│       ├── AccountsTable.tsx       # Existing
│       ├── RuleList.tsx            # Existing
│       ├── SurchargeSettings.tsx   # Existing
│       ├── AccountingEntriesTab.tsx    # NEW
│       ├── GLBatchRunsTab.tsx          # NEW
│       ├── SalesBatchList.tsx          # NEW
│       ├── PaymentBatchList.tsx        # NEW
│       ├── InvoiceBatchesTab.tsx       # NEW
│       ├── BatchPreviewModal.tsx       # NEW
│       └── ExportPanel.tsx             # NEW
└── hooks/
    ├── useAccountingEntries.ts     # NEW - GraphQL
    ├── useGLBatchRuns.ts           # NEW - REST
    ├── useInvoiceBatches.ts        # NEW - REST
    └── useExport.ts                # NEW
```

---

## 8. Permissions

| Permission | Description |
|------------|-------------|
| `view:accounting_entries` | View entries, GL batches, invoice batches |
| `execute:gl_batch` | Trigger GL catchup processing |
| `execute:invoice_batch` | Create new invoice batches |
| `export:invoice_batch` | Export batches to accounting software |

---

## 9. Integration with jsg_clients

Add "View Invoices" button on client detail (for clients with payment terms):

```tsx
{client.payment_terms_id && (
  <Button
    variant="outline"
    onClick={() => onNavigateToApp?.(`/gl-rules?tab=invoices&client=${client.id}`)}
  >
    <FileText className="w-4 h-4 mr-2" />
    View Invoices
  </Button>
)}
```

---

## 10. Success Metrics

| Metric | Target |
|--------|--------|
| GL batch visibility | 100% of batch runs viewable in UI |
| Failed record resolution | < 24h to identify and resolve failures |
| Time to export invoice batch | < 30 seconds |
| User adoption | 80% of invoice batches created via UI |

---

## 11. Future Enhancements (Out of Scope for V1)

- Direct Xero/MYOB API integration (push vs download)
- Scheduled automatic invoice batch execution
- Email notifications for GL batch failures
- PDF invoice generation
- Email invoices directly to clients
- Multi-currency support
- Enhanced processing statistics display from job_initiations notes

---

## Appendix A: Database Schema Reference (Validated via RAG)

### accounting_entries
```sql
CREATE TABLE accounting_entries (
  id BIGSERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  recognised_at TIMESTAMPTZ,
  association_type TEXT,               -- Links to 'money' table
  association_id BIGINT,
  deleted BOOLEAN NOT NULL DEFAULT false,
  account_id BIGINT,
  amount NUMERIC(19,2),
  recognised_at_local TIMESTAMPTZ
);
-- 126 rows in tta schema
```

### accounts
```sql
CREATE TABLE accounts (
  id SERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  name VARCHAR(255) NOT NULL,
  external_id VARCHAR(255) NOT NULL,   -- GL account code
  deleted BOOLEAN DEFAULT false
);
-- 3 rows in tta schema
```

### sales_batch_runs
```sql
CREATE TABLE sales_batch_runs (
  id SERIAL PRIMARY KEY,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
-- 88 rows in tta schema
-- Note: No processing stats columns - these are in sales_batch_job_initiations.notes
```

### payment_batch_runs
```sql
CREATE TABLE payment_batch_runs (
  id SERIAL PRIMARY KEY,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
-- 92 rows in tta schema
```

### sales_batch_job_initiations
```sql
CREATE TABLE sales_batch_job_initiations (
  id SERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  batch_date DATE NOT NULL,
  completed BOOLEAN DEFAULT false,
  notes TEXT                           -- Contains detailed processing results as text
);
-- 71 rows in tta schema
```

### invoice_batches
```sql
CREATE TABLE invoice_batches (
  id SERIAL PRIMARY KEY,
  issue_date DATE NOT NULL,
  run_by VARCHAR(255),                 -- 'manual' or 'sched'
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  exported_by INTEGER,                 -- User ID who exported
  exported_at TIMESTAMP                -- When batch was exported
);
-- Note: No invoice_count, total_amount - these are computed from related tables
```

### invoices
```sql
CREATE TABLE invoices (
  id SERIAL PRIMARY KEY,
  client_id INTEGER,
  client_external_id VARCHAR(255),
  issue_date DATE,
  due_date DATE,
  invoice_batch_id INTEGER REFERENCES invoice_batches(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

### invoice_line_items
```sql
CREATE TABLE invoice_line_items (
  id SERIAL PRIMARY KEY,
  payment_id INTEGER,
  booking_reference VARCHAR(255),
  booking_description TEXT,
  amount NUMERIC(12,2),
  invoice_id INTEGER REFERENCES invoices(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

### money (key fields for accounting)
```sql
CREATE TABLE money (
  id INTEGER PRIMARY KEY,
  type VARCHAR,
  association_type VARCHAR,            -- 'pat-reservation'
  association_id INTEGER,
  amount NUMERIC,
  account_id INTEGER,
  recognised_at TIMESTAMP,             -- Accounting period assignment
  reservation_id INTEGER,
  deleted BOOLEAN DEFAULT false,
  -- ... additional fields
);
-- 12,053 rows in tta schema
```

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-02-04 | Claude Code | Initial draft |
| 1.1 | 2026-02-04 | Claude Code | Updated: extend jsg_gl_rules, automatic recognition, reversal display, client deep-link |
| 1.2 | 2026-02-04 | Claude Code | Added GL Batch Runs tab, API Enhancement Requests section |
| 1.3 | 2026-02-04 | Claude Code | **Schema Validation**: Updated all schemas using RAG database validation. Corrected endpoint responses to reflect actual table structures. Marked new endpoints as deployed. Added row counts. Clarified that batch processing stats are in job_initiations.notes, not in batch_runs tables. |
